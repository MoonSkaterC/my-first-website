import os
import pdfplumber
import csv
import re

def extract_ups_tracking_numbers(pdf_path):
    """
    Extract UPS tracking numbers starting with 1Z from even pages only
    Uses OCR for scanned PDFs
    """
    tracking_numbers = []
    
    try:
        # Try to import OCR dependencies
        try:
            import pytesseract
            from pdf2image import convert_from_path
            ocr_available = True
            print("✓ OCR available (will read scanned PDFs)\n")
        except ImportError as e:
            ocr_available = False
            print("⚠ OCR not available")
            print(f"  Missing: {e}")
            print("  Install: pip install pytesseract pdf2image pillow\n")
        
        with pdfplumber.open(pdf_path) as pdf:
            print(f"Total pages: {len(pdf.pages)}")
            print("Processing even pages only (2, 4, 6, ...)...\n")
            
            for page_num in range(len(pdf.pages)):
                actual_page_number = page_num + 1
                
                # Only process EVEN pages
                if actual_page_number % 2 != 0:
                    continue
                
                page = pdf.pages[page_num]
                text = page.extract_text()
                
                print(f"Page {actual_page_number}:")
                
                # If no text extracted or very little text, try OCR
                if not text or len(text.strip()) < 10:
                    if ocr_available:
                        print("  No text found - trying OCR...")
                        try:
                            # Convert PDF page to image using pdf2image
                            images = convert_from_path(
                                pdf_path, 
                                first_page=actual_page_number,
                                last_page=actual_page_number,
                                dpi=300
                            )
                            
                            if images:
                                # OCR the image
                                text = pytesseract.image_to_string(
                                    images[0],
                                    config='--psm 6'  # Assume uniform block of text
                                )
                                print(f"  OCR extracted {len(text)} characters")
                            else:
                                print("  Could not convert page to image")
                                text = ""
                        except Exception as e:
                            print(f"  OCR failed: {e}")
                            text = ""
                    else:
                        print("  No text found (PDF is scanned)")
                        print("  Install OCR support:")
                        print("    pip install pytesseract pdf2image pillow")
                        print("  Also install Tesseract OCR:")
                        print("    Windows: https://github.com/UB-Mannheim/tesseract/wiki")
                        print("    Mac: brew install tesseract")
                        print("    Linux: sudo apt-get install tesseract-ocr")
                        continue
                
                if not text:
                    print("  No text available\n")
                    continue
                
                # Show a sample of extracted text
                sample = text[:200].replace('\n', ' ')
                print(f"  Text sample: {sample}...")
                
                # Find ALL occurrences of UPS tracking numbers
                found_in_page = []
                
                # UPS tracking format: 1Z followed by 16 alphanumeric characters
                # Total: 18 characters (1Z + 16 more)
                # Pattern allows for spaces or no spaces
                
                # Remove all spaces for easier matching
                text_no_spaces = text.replace(' ', '').replace('\n', '').replace('\r', '')
                
                # Find all matches of 1Z followed by 16 alphanumeric chars
                pattern = r'1Z[A-Z0-9]{16}'
                matches = re.findall(pattern, text_no_spaces, re.IGNORECASE)
                
                for match in matches:
                    # Clean up the tracking number
                    tracking = match.upper()
                    
                    # Replace letter O with number 0 (common OCR error)
                    tracking = tracking.replace('O', '0')
                    
                    # Avoid duplicates
                    if tracking not in found_in_page:
                        found_in_page.append(tracking)
                        tracking_numbers.append(tracking)
                
                if found_in_page:
                    print(f"  ✓ Found {len(found_in_page)} tracking number(s):")
                    for tn in found_in_page:
                        # Format with spaces for readability: 1Z XXX XXX XX XXXX XXXX X
                        formatted = f"{tn[0:2]} {tn[2:5]} {tn[5:8]} {tn[8:10]} {tn[10:14]} {tn[14:18]}"
                        print(f"    • {formatted} (Raw: {tn})")
                else:
                    print("  No tracking numbers found")
                print()
    
    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()
        return []
    
    return tracking_numbers

def save_to_csv(tracking_numbers, output_path):
    """Save tracking numbers to CSV"""
    with open(output_path, 'w', newline='', encoding='utf-8') as f:
        writer = csv.writer(f)
        writer.writerow(['Tracking Number'])
        for tn in tracking_numbers:
            writer.writerow([tn])
    print(f"✓ Saved {len(tracking_numbers)} tracking numbers to: {output_path}\n")

def main():
    # Find desktop
    desktop = os.path.join(os.path.expanduser("~"), "Desktop")
    if not os.path.exists(desktop):
        desktop = os.path.join(os.path.expanduser("~"), "OneDrive", "Desktop")
    
    # Find PDF
    pdf_path = os.path.join(desktop, "UPSTracking.pdf")
    
    if not os.path.exists(pdf_path):
        print(f"ERROR: UPSTracking.pdf not found at {desktop}")
        print("\nEnter full path to PDF:")
        pdf_path = input("> ").strip().strip('"')
        if not os.path.exists(pdf_path):
            print("File not found. Exiting.")
            return
    
    print(f"Reading: {pdf_path}\n")
    
    # Extract
    tracking_numbers = extract_ups_tracking_numbers(pdf_path)
    
    if not tracking_numbers:
        print("\n❌ No tracking numbers found")
        print("\nTroubleshooting:")
        print("1. Make sure PDF has tracking numbers on EVEN pages (2, 4, 6...)")
        print("2. Check if tracking numbers follow format: 1Z + 16 alphanumeric chars")
        print("3. If PDF is scanned, make sure OCR is installed (see messages above)")
        print("4. Try opening the PDF manually to verify it contains readable text")
        return
    
    # Remove duplicates
    tracking_numbers = list(dict.fromkeys(tracking_numbers))
    
    print(f"\n{'='*60}")
    print(f"TOTAL FOUND: {len(tracking_numbers)} unique tracking numbers")
    print(f"{'='*60}\n")
    
    # Save
    output_path = os.path.join(desktop, "ups_tracking_numbers.csv")
    save_to_csv(tracking_numbers, output_path)
    
    print("✅ DONE!")
    input("\nPress Enter to exit...")

if __name__ == "__main__":
    main()